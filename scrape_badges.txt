from flask import Flask, jsonify
from flask_cors import CORS
import requests
from bs4 import BeautifulSoup
import csv
import time

app = Flask(__name__)
CORS(app)  # allow Vite frontend access

def get_badge_count(url):
    headers = {'User-Agent': 'Mozilla/5.0'}
    try:
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            soup = BeautifulSoup(response.text, 'html.parser')
            badge_links = soup.find_all('a', href=lambda x: bool(x) and 'badges' in str(x).lower())
            return len(badge_links)
        else:
            return "Error"
    except Exception as e:
        return f"Error: {str(e)}"

@app.route('/api/students', methods=['GET'])
def get_students():
    students_data = []

    with open('studnet.csv', 'r') as file:

        csv_reader = csv.DictReader(file)
        for student in csv_reader:
            name = student['User Name']
            url = student['Google Cloud Skills Boost Profile URL']
            badge_count = get_badge_count(url)
            students_data.append({
                'name': name,
                'badges': badge_count
            })
            time.sleep(0.5)
    return jsonify(students_data)

if __name__ == '__main__':
    app.run(port=5000, debug=True)